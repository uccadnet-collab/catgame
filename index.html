<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ìœ í˜„ì´ ê³ ì–‘ì´ì˜ ëª¨í—˜</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; touch-action:none; -webkit-tap-highlight-color:transparent; }

    html, body { width:100%; height:100%; overflow:hidden; background:#000; font-family:'Arial',sans-serif; }

    /* â”€â”€ ì„¸ë¡œëª¨ë“œ ê²½ê³  â”€â”€ */
    #rotate-msg {
      display:none; position:fixed; inset:0; background:#111; color:#fff;
      flex-direction:column; align-items:center; justify-content:center;
      z-index:9999; font-size:22px; gap:20px; text-align:center; padding:20px;
    }
    #rotate-msg .icon { font-size:64px; animation:spin 2s linear infinite; }
    @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(90deg)} }
    @media (orientation:portrait) { #rotate-msg { display:flex; } }

    /* â”€â”€ ê²Œì„ ë£¨íŠ¸ â”€â”€ */
    #game-root {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:#000;
    }

    /* â”€â”€ ìº”ë²„ìŠ¤ ë˜í¼: JSê°€ í¬ê¸° ê²°ì • â”€â”€ */
    #game-wrapper {
      position:relative;
      background:#000;
      /* ìµœëŒ€í•œ í™”ë©´ì„ ì±„ìš°ë„ë¡ JSì—ì„œ ë™ì  ì„¤ì • */
    }

    #canvas {
      display:block;
      width:100%; height:100%;
      image-rendering:pixelated;
      image-rendering:crisp-edges;
    }

    /* â”€â”€ HUD â”€â”€ */
    #ui {
      position:absolute; top:0; left:0; right:0;
      display:flex; justify-content:space-between;
      padding:6px 14px;
      font-size:clamp(11px,2vw,16px); font-weight:bold;
      color:#fff; text-shadow:0 1px 4px #000,0 0 8px #000;
      pointer-events:none; z-index:10;
    }

    /* â”€â”€ ë©”ì¸ ì˜¤ë²„ë ˆì´ â”€â”€ */
    #overlay {
      position:absolute; inset:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:8px; background:rgba(0,0,0,0.72); z-index:20;
    }
    #overlay h1 {
      font-size:clamp(18px,4.5vw,40px); color:#e94560;
      text-shadow:0 0 20px #e94560; text-align:center; padding:0 12px;
    }
    #overlay p  { font-size:clamp(11px,1.8vw,16px); color:#eee; text-align:center; padding:0 12px; }
    #overlay .sub { font-size:clamp(10px,1.4vw,13px); color:#aaa; }
    #startBtn {
      padding:9px 28px; font-size:clamp(14px,2.2vw,18px);
      background:#e94560; color:#fff; border:none; border-radius:8px; cursor:pointer; margin-top:4px;
    }
    #startBtn:active { background:#c73652; }

    /* â”€â”€ ë­í‚¹ ì˜¤ë²„ë ˆì´ â”€â”€ */
    #rank-overlay {
      position:absolute; inset:0; display:none;
      flex-direction:column; align-items:center; justify-content:center;
      gap:8px; background:rgba(0,0,0,0.88); z-index:30; color:#fff;
      overflow-y:auto; padding:12px 0;
    }
    #rank-overlay h2 { font-size:clamp(18px,3.5vw,30px); color:#ffd700; text-shadow:0 0 12px #ffd700; }
    #rank-overlay input {
      padding:7px 14px; font-size:16px; border-radius:8px;
      border:2px solid #e94560; background:#222; color:#fff;
      text-align:center; width:180px;
    }
    #rank-overlay button {
      padding:7px 22px; font-size:15px; background:#e94560;
      color:#fff; border:none; border-radius:8px; cursor:pointer;
    }

    /* ë­í‚¹ ë‘ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ */
    #rank-cols {
      display:flex; gap:24px; align-items:flex-start; justify-content:center;
      width:100%; max-width:560px; padding:0 12px;
    }
    .rank-col { flex:1; }
    .rank-col h3 { font-size:13px; color:#ffd700; text-align:center; margin-bottom:4px; }
    .rank-list-inner {
      list-style:none; width:100%;
    }
    .rank-list-inner li {
      display:flex; justify-content:space-between;
      padding:3px 6px; border-bottom:1px solid #333; font-size:12px;
    }
    .rank-list-inner li:nth-child(1) { color:#ffd700; }
    .rank-list-inner li:nth-child(2) { color:#c0c0c0; }
    .rank-list-inner li:nth-child(3) { color:#cd7f32; }

    #rank-status { font-size:12px; color:#aaa; min-height:15px; text-align:center; }

    /* â”€â”€ ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ â”€â”€ */
    #mobile-controls {
      display:none; position:absolute;
      bottom:env(safe-area-inset-bottom,8px); left:0; right:0;
      justify-content:space-between; align-items:flex-end;
      padding:0 16px; pointer-events:none; z-index:15;
    }
    .ctrl-group { display:flex; gap:8px; pointer-events:all; }
    .ctrl-btn {
      width:clamp(48px,9vw,64px); height:clamp(48px,9vw,64px);
      border-radius:50%; border:2px solid rgba(255,255,255,0.45);
      background:rgba(255,255,255,0.13); color:#fff;
      font-size:clamp(18px,3.5vw,26px); cursor:pointer; user-select:none;
      display:flex; align-items:center; justify-content:center;
      pointer-events:all; backdrop-filter:blur(4px); transition:background 0.1s;
    }
    .ctrl-btn:active,.ctrl-btn.pressed { background:rgba(255,255,255,0.38); }
    #btn-shoot { background:rgba(233,69,96,0.22); border-color:rgba(233,69,96,0.55); }
    #btn-shoot.pressed { background:rgba(233,69,96,0.52); }

    /* ìŒì•… í† ê¸€ ë²„íŠ¼ */
    #music-btn {
      position:absolute; top:30px; right:8px;
      background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3);
      color:#fff; border-radius:50%; width:32px; height:32px;
      font-size:16px; cursor:pointer; z-index:12;
      display:flex; align-items:center; justify-content:center;
      backdrop-filter:blur(4px);
    }

    @media (pointer:coarse),(max-width:900px) { #mobile-controls { display:flex; } }
  </style>
</head>
<body>

<div id="rotate-msg">
  <div class="icon">ğŸ“±</div>
  <div>ğŸ“º ê°€ë¡œë¡œ ëŒë ¤ì£¼ì„¸ìš”!<br><span style="font-size:15px;color:#aaa;">ì´ ê²Œì„ì€ ê°€ë¡œ ëª¨ë“œì—ì„œ í”Œë ˆì´í•˜ì„¸ìš”</span></div>
</div>

<div id="game-root">
  <div id="game-wrapper">
    <canvas id="canvas"></canvas>

    <!-- HUD -->
    <div id="ui">
      <span>ì ìˆ˜: <span id="scoreDisplay">0</span></span>
      <span>ë ˆë²¨: <span id="levelDisplay">1</span>/20</span>
      <span>ìƒëª…: <span id="livesDisplay">â¤ï¸Ã—10</span></span>
    </div>

    <!-- ìŒì•… í† ê¸€ -->
    <button id="music-btn" title="ìŒì•… ì¼œê¸°/ë„ê¸°">ğŸ”Š</button>

    <!-- ë©”ì¸ ì˜¤ë²„ë ˆì´ -->
    <div id="overlay">
      <h1>ğŸ± ìœ í˜„ì´ ê³ ì–‘ì´ì˜ ëª¨í—˜</h1>
      <p>ì ì„ í”¼í•˜ê³  ì½”ì¸ì„ ëª¨ì•„ë¼!</p>
      <p class="sub">ì½”ì¸ 10ê°œ = âš¡ìŠˆí¼ ëª¨ë“œ 10ì´ˆ!</p>
      <p class="sub">â† â†’ ì´ë™ &nbsp;|&nbsp; â†‘/Space ì í”„ &nbsp;|&nbsp; Z/Ctrl ë°œì‚¬</p>
      <button id="startBtn">ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- ë­í‚¹ ì˜¤ë²„ë ˆì´ -->
    <div id="rank-overlay">
      <h2>ğŸ† ê²Œì„ ì¢…ë£Œ!</h2>
      <p id="rank-score-text" style="font-size:16px;"></p>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="text" id="name-input" maxlength="10" placeholder="ì´ë¦„ ì…ë ¥">
        <button id="rank-save-btn">ì €ì¥</button>
      </div>
      <p id="rank-status"></p>

      <!-- ë­í‚¹ ë‘ ì»¬ëŸ¼: ì „ì²´ / ì˜¤ëŠ˜ -->
      <div id="rank-cols">
        <div class="rank-col">
          <h3>ğŸŒ ì „ì²´ TOP 10</h3>
          <ul class="rank-list-inner" id="rank-list-all"></ul>
        </div>
        <div class="rank-col">
          <h3>ğŸ“… ì˜¤ëŠ˜ TOP 10</h3>
          <ul class="rank-list-inner" id="rank-list-today"></ul>
        </div>
      </div>

      <button id="rank-retry-btn" style="margin-top:8px;background:#555;">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <!-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ -->
    <div id="mobile-controls">
      <div class="ctrl-group">
        <button class="ctrl-btn" id="btn-left">â—€</button>
        <button class="ctrl-btn" id="btn-right">â–¶</button>
      </div>
      <div class="ctrl-group">
        <button class="ctrl-btn" id="btn-shoot">ğŸ”«</button>
        <button class="ctrl-btn" id="btn-jump">â–²</button>
      </div>
    </div>
  </div>
</div>

<!-- í™”ë©´ ê½‰ ì±„ìš°ê¸° (ê°€ë¡œ ìš°ì„ , ì„¸ë¡œ ë§ì¶¤) -->
<script>
  const GAME_W = 800, GAME_H = 450;
  const wrapper = document.getElementById('game-wrapper');
  function resizeGame() {
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    // í™”ë©´ì„ ìµœëŒ€í•œ ì±„ìš°ë˜ ë¹„ìœ¨ ìœ ì§€ (ì—¬ë°± ìµœì†Œí™”)
    const scaleX = vw / GAME_W;
    const scaleY = vh / GAME_H;
    // ê°€ë¡œ í™”ë©´ì—ì„œëŠ” ë†’ì´ ê¸°ì¤€ìœ¼ë¡œ ë§ì¶”ê³  ê°€ë¡œëŠ” ê½‰ ì±„ì›€
    // ì„¸ë¡œ ì—¬ë°±ì´ ìƒê¸°ì§€ ì•Šë„ë¡ ë†’ì´ ê¸°ì¤€ ìš°ì„ 
    const scale = Math.max(scaleX, scaleY); // í™”ë©´ì„ ê½‰ ì±„ì›€ (crop ë°©ì‹)
    // ë‹¨, ë„ˆë¬´ ë§ì´ ì˜ë¦¬ë©´ min ë°©ì‹ ì‚¬ìš©
    const safeScale = scaleY; // ë†’ì´ì— ë§ì¶”ê³  ì¢Œìš°ëŠ” ëŠ˜ì–´ë‚¨
    // ì‹¤ì œë¡œëŠ” ê°€ë¡œëŠ” vw ì „ì²´, ë†’ì´ëŠ” ë¹„ìœ¨ ë§ì¶¤
    const w = vw;
    const h = Math.round(vw / GAME_W * GAME_H);
    if (h <= vh) {
      // ê°€ë¡œ ê½‰ ì±„ìš°ê³  ë†’ì´ëŠ” ë¹„ìœ¨
      wrapper.style.width  = vw + 'px';
      wrapper.style.height = h + 'px';
    } else {
      // ë†’ì´ ê½‰ ì±„ìš°ê³  ê°€ë¡œëŠ” ë¹„ìœ¨
      const h2 = vh;
      const w2 = Math.round(vh / GAME_H * GAME_W);
      wrapper.style.width  = w2 + 'px';
      wrapper.style.height = h2 + 'px';
    }
  }
  resizeGame();
  window.addEventListener('resize', resizeGame);
  screen.orientation && screen.orientation.addEventListener('change', () => {
    setTimeout(resizeGame, 100);
  });
</script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, onValue }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAO0VHL-RJsq0zbcgtKaP6GQHKXl5-DGu4",
    authDomain: "catgame-f0b19.firebaseapp.com",
    databaseURL: "https://catgame-f0b19-default-rtdb.firebaseio.com",
    projectId: "catgame-f0b19",
    storageBucket: "catgame-f0b19.firebasestorage.app",
    messagingSenderId: "343313541352",
    appId: "1:343313541352:web:fc0a1ff14a249a6627415d",
    measurementId: "G-7YZ3F9C453"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const rankingRef = ref(db, 'rankings');
  const MEDALS = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];

  function todayStr() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function buildList(entries, ulId) {
    const ul = document.getElementById(ulId);
    ul.innerHTML = '';
    if (!entries.length) {
      ul.innerHTML = '<li style="color:#666;justify-content:center;font-size:12px;">ê¸°ë¡ ì—†ìŒ</li>';
      return;
    }
    entries.forEach((r, i) => {
      const li = document.createElement('li');
      const medal = MEDALS[i] || `${i+1}.`;
      li.innerHTML = `<span>${medal} ${r.name}</span><span>${r.score.toLocaleString()}ì </span>`;
      ul.appendChild(li);
    });
  }

  function renderRankLists(data) {
    if (!data) {
      buildList([], 'rank-list-all');
      buildList([], 'rank-list-today');
      return;
    }
    const all   = Object.values(data).sort((a,b)=>b.score-a.score).slice(0,10);
    const today = Object.values(data).filter(r=>r.dateKey===todayStr()).sort((a,b)=>b.score-a.score).slice(0,10);
    buildList(all,   'rank-list-all');
    buildList(today, 'rank-list-today');
  }

  function subscribeRanking() {
    onValue(rankingRef, snap => renderRankLists(snap.val()));
  }

  async function saveScore(name, score) {
    const now  = new Date();
    const date = `${now.getMonth()+1}/${now.getDate()}`;
    await push(rankingRef, { name, score, date, dateKey: todayStr(), ts: Date.now() });
  }

  window.firebaseRanking = { subscribe: subscribeRanking, save: saveScore };

  // ì €ì¥ ë²„íŠ¼
  document.getElementById('rank-save-btn').addEventListener('click', async () => {
    const name   = document.getElementById('name-input').value.trim() || 'í”Œë ˆì´ì–´';
    const score  = window._gameScore || 0;
    const btn    = document.getElementById('rank-save-btn');
    const status = document.getElementById('rank-status');
    btn.disabled = true;
    status.textContent = 'ì €ì¥ ì¤‘...';
    try {
      await saveScore(name, score);
      status.textContent = 'âœ… ì €ì¥ ì™„ë£Œ!';
      btn.textContent = 'ì €ì¥ë¨ âœ“';
      document.getElementById('name-input').value = '';
    } catch(e) {
      status.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ í™•ì¸';
      btn.disabled = false;
    }
  });

  // ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼
  document.getElementById('rank-retry-btn').addEventListener('click', () => {
    document.getElementById('rank-overlay').style.display = 'none';
    document.getElementById('rank-save-btn').textContent = 'ì €ì¥';
    document.getElementById('rank-save-btn').disabled = false;
    document.getElementById('rank-status').textContent = '';
    if (window._gameShowMenu) window._gameShowMenu();
  });

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ êµ¬ë… (ë©”ë‰´ì—ì„œë„ ë­í‚¹ ë³´ì„)
  window.addEventListener('load', subscribeRanking);
</script>

<script src="game.js"></script>
</body>
</html>
