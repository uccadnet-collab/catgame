<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ìœ í˜„ì´ ê³ ì–‘ì´ì˜ ëª¨í—˜</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; -webkit-tap-highlight-color: transparent; }

    html, body {
      width: 100%; height: 100%;
      overflow: hidden;
      background: #000;
      font-family: 'Arial', sans-serif;
    }

    /* â”€â”€ ì„¸ë¡œ ëª¨ë“œ ê²½ê³  â”€â”€ */
    #rotate-msg {
      display: none;
      position: fixed; inset: 0;
      background: #111;
      color: #fff;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 22px;
      gap: 20px;
      text-align: center;
      padding: 20px;
    }
    #rotate-msg .icon { font-size: 64px; animation: spin 2s linear infinite; }
    @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(90deg)} }
    @media (orientation: portrait) {
      #rotate-msg { display: flex; }
    }

    /* â”€â”€ ê²Œì„ ì „ì²´ ì»¨í…Œì´ë„ˆ â”€â”€ */
    #game-root {
      position: fixed; inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    /* â”€â”€ ìº”ë²„ìŠ¤ ë˜í¼ â”€â”€ */
    #game-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #canvas {
      display: block;
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
    }

    /* â”€â”€ UI HUD (ìº”ë²„ìŠ¤ ìœ„ì— ì ˆëŒ€ ìœ„ì¹˜) â”€â”€ */
    #ui {
      position: absolute;
      top: env(safe-area-inset-top, 8px);
      left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      padding: 6px 14px;
      font-size: clamp(12px, 2.5vw, 17px);
      font-weight: bold;
      color: #fff;
      text-shadow: 0 1px 4px #000, 0 0 8px #000;
      pointer-events: none;
      z-index: 10;
    }

    /* â”€â”€ ì˜¤ë²„ë ˆì´ â”€â”€ */
    #overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: rgba(0,0,0,0.70);
      z-index: 20;
    }
    #overlay h1 {
      font-size: clamp(22px, 5vw, 44px);
      color: #e94560;
      text-shadow: 0 0 20px #e94560;
      text-align: center;
      padding: 0 12px;
    }
    #overlay p { font-size: clamp(12px, 2vw, 18px); color: #eee; text-align: center; padding: 0 12px; }
    #overlay .sub { font-size: clamp(11px, 1.6vw, 14px); color: #aaa; }
    #startBtn {
      padding: 10px 32px;
      font-size: clamp(15px, 2.5vw, 20px);
      background: #e94560;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 4px;
    }
    #startBtn:active { background: #c73652; }

    /* â”€â”€ ë­í‚¹ ì…ë ¥ ì˜¤ë²„ë ˆì´ â”€â”€ */
    #rank-overlay {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: rgba(0,0,0,0.80);
      z-index: 30;
      color: #fff;
    }
    #rank-overlay h2 { font-size: clamp(20px, 4vw, 36px); color: #ffd700; text-shadow: 0 0 12px #ffd700; }
    #rank-overlay input {
      padding: 8px 16px;
      font-size: 18px;
      border-radius: 8px;
      border: 2px solid #e94560;
      background: #222;
      color: #fff;
      text-align: center;
      width: 220px;
    }
    #rank-overlay button {
      padding: 8px 28px;
      font-size: 16px;
      background: #e94560;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #rank-list {
      list-style: none;
      width: 260px;
      max-height: 160px;
      overflow-y: auto;
    }
    #rank-list li {
      display: flex;
      justify-content: space-between;
      padding: 4px 8px;
      border-bottom: 1px solid #333;
      font-size: 14px;
    }
    #rank-list li:nth-child(1) { color: #ffd700; }
    #rank-list li:nth-child(2) { color: #c0c0c0; }
    #rank-list li:nth-child(3) { color: #cd7f32; }
    #rank-status {
      font-size: 12px; color: #aaa; min-height: 16px; text-align: center;
    }
    #rank-list li .rank-medal { margin-right: 4px; }

    /* â”€â”€ ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ (ìº”ë²„ìŠ¤ ì•ˆ ìš°ì¸¡/ì¢Œì¸¡ í•˜ë‹¨) â”€â”€ */
    #mobile-controls {
      display: none;
      position: absolute;
      bottom: env(safe-area-inset-bottom, 12px);
      left: 0; right: 0;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0 20px;
      pointer-events: none;
      z-index: 15;
    }
    .ctrl-group { display: flex; gap: 8px; pointer-events: all; }
    .ctrl-btn {
      width: clamp(52px, 10vw, 68px);
      height: clamp(52px, 10vw, 68px);
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-size: clamp(20px, 4vw, 28px);
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: all;
      backdrop-filter: blur(4px);
      transition: background 0.1s;
    }
    .ctrl-btn:active, .ctrl-btn.pressed {
      background: rgba(255,255,255,0.40);
    }
    #btn-shoot {
      background: rgba(233,69,96,0.25);
      border-color: rgba(233,69,96,0.6);
    }
    #btn-shoot.pressed { background: rgba(233,69,96,0.55); }

    @media (pointer: coarse), (max-width: 900px) {
      #mobile-controls { display: flex; }
    }
  </style>
</head>
<body>

<!-- ì„¸ë¡œëª¨ë“œ ê²½ê³  -->
<div id="rotate-msg">
  <div class="icon">ğŸ“±</div>
  <div>ğŸ“º ê°€ë¡œë¡œ ëŒë ¤ì£¼ì„¸ìš”!<br><span style="font-size:15px;color:#aaa;">ì´ ê²Œì„ì€ ê°€ë¡œ ëª¨ë“œì—ì„œ í”Œë ˆì´í•˜ì„¸ìš”</span></div>
</div>

<div id="game-root">
  <div id="game-wrapper">
    <canvas id="canvas"></canvas>

    <!-- HUD -->
    <div id="ui">
      <span>ì ìˆ˜: <span id="scoreDisplay">0</span></span>
      <span>ë ˆë²¨: <span id="levelDisplay">1</span>/20</span>
      <span>ìƒëª…: <span id="livesDisplay">â¤ï¸Ã—10</span></span>
    </div>

    <!-- ë©”ì¸ ì˜¤ë²„ë ˆì´ -->
    <div id="overlay">
      <h1>ğŸ± ìœ í˜„ì´ ê³ ì–‘ì´ì˜ ëª¨í—˜</h1>
      <p>ì ì„ í”¼í•˜ê³  ì½”ì¸ì„ ëª¨ì•„ë¼!</p>
      <p class="sub">ì½”ì¸ 10ê°œ = âš¡ìŠˆí¼ ëª¨ë“œ 10ì´ˆ!</p>
      <p class="sub">â† â†’ ì´ë™ &nbsp;|&nbsp; â†‘/Space ì í”„ &nbsp;|&nbsp; Z/Ctrl ë°œì‚¬</p>
      <button id="startBtn">ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- ë­í‚¹ ì˜¤ë²„ë ˆì´ -->
    <div id="rank-overlay">
      <h2>ğŸ† ê²Œì„ ì¢…ë£Œ!</h2>
      <p id="rank-score-text" style="font-size:18px;"></p>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="text" id="name-input" maxlength="10" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button id="rank-save-btn">ì €ì¥</button>
      </div>
      <p id="rank-status"></p>
      <p style="color:#ffd700;font-size:13px;margin-top:2px;">ğŸŒ ì „ì²´ ë­í‚¹ TOP 10</p>
      <ul id="rank-list"></ul>
      <button id="rank-retry-btn" style="margin-top:6px;background:#555;">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

    <!-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ -->
    <div id="mobile-controls">
      <div class="ctrl-group">
        <button class="ctrl-btn" id="btn-left">â—€</button>
        <button class="ctrl-btn" id="btn-right">â–¶</button>
      </div>
      <div class="ctrl-group">
        <button class="ctrl-btn" id="btn-shoot">ğŸ”«</button>
        <button class="ctrl-btn" id="btn-jump" style="font-size:clamp(22px,4vw,30px);">â–²</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, query, orderByChild, limitToLast, onValue, get }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAO0VHL-RJsq0zbcgtKaP6GQHKXl5-DGu4",
    authDomain: "catgame-f0b19.firebaseapp.com",
    databaseURL: "https://catgame-f0b19-default-rtdb.firebaseio.com",
    projectId: "catgame-f0b19",
    storageBucket: "catgame-f0b19.firebasestorage.app",
    messagingSenderId: "343313541352",
    appId: "1:343313541352:web:fc0a1ff14a249a6627415d",
    measurementId: "G-7YZ3F9C453"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const rankingRef = ref(db, 'rankings');

  const MEDALS = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];

  // ë­í‚¹ ì‹¤ì‹œê°„ ë Œë”ë§
  function renderRankList(data) {
    const ul = document.getElementById('rank-list');
    ul.innerHTML = '';
    if (!data) { ul.innerHTML = '<li style="color:#aaa;justify-content:center;">ê¸°ë¡ ì—†ìŒ</li>'; return; }
    const entries = Object.values(data)
      .sort((a,b) => b.score - a.score)
      .slice(0, 10);
    entries.forEach((r, i) => {
      const li = document.createElement('li');
      const medal = MEDALS[i] || `${i+1}.`;
      const date  = r.date ? `<span style="color:#666;font-size:11px">${r.date}</span>` : '';
      li.innerHTML = `<span><span class="rank-medal">${medal}</span>${r.name}</span><span>${r.score.toLocaleString()}ì  ${date}</span>`;
      ul.appendChild(li);
    });
  }

  // ë­í‚¹ ì‹¤ì‹œê°„ êµ¬ë…
  function subscribeRanking() {
    onValue(rankingRef, snap => {
      renderRankList(snap.val());
    });
  }

  // ì ìˆ˜ ì €ì¥
  async function saveScore(name, score) {
    const now = new Date();
    const date = `${now.getMonth()+1}/${now.getDate()}`;
    await push(rankingRef, { name, score, date, ts: Date.now() });
  }

  // game.jsì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ windowì— ë“±ë¡
  window.firebaseRanking = {
    subscribe: subscribeRanking,
    save: saveScore,
  };

  // ì €ì¥ ë²„íŠ¼
  document.getElementById('rank-save-btn').addEventListener('click', async () => {
    const name  = document.getElementById('name-input').value.trim() || 'í”Œë ˆì´ì–´';
    const score = window._gameScore || 0;
    const btn   = document.getElementById('rank-save-btn');
    const status = document.getElementById('rank-status');

    btn.disabled = true;
    status.textContent = 'ì €ì¥ ì¤‘...';
    try {
      await saveScore(name, score);
      status.textContent = 'âœ… ì €ì¥ ì™„ë£Œ!';
      btn.textContent = 'ì €ì¥ë¨ âœ“';
      document.getElementById('name-input').value = '';
    } catch(e) {
      status.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ í™•ì¸';
      btn.disabled = false;
    }
  });

  // ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼
  document.getElementById('rank-retry-btn').addEventListener('click', () => {
    document.getElementById('rank-overlay').style.display = 'none';
    document.getElementById('rank-save-btn').textContent = 'ì €ì¥';
    document.getElementById('rank-save-btn').disabled = false;
    document.getElementById('rank-status').textContent = '';
    if (window._gameShowMenu) window._gameShowMenu();
  });

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë­í‚¹ êµ¬ë… ì‹œì‘
  window.addEventListener('load', () => {
    subscribeRanking();
  });
</script>

<script src="game.js"></script>
</body>
</html>
